[2025-04-11 05:17:38] - Обнаружена иерархическая структура данных в таблице items

Структура связей:
1. Корневой элемент:
   - id: ed6c9ff8-7673-4958-9d47-3d5477fab14a
   - txt: null (корень иерархии)

2. Основные ветви:
   - "Knowledge Universe TIP" (id: 4566b621-926d-4405-82a1-f76728e8d93f)
     - Дочерние элементы:
       * "Дела" (родитель для цепочки дат)
       * "Порталы групп"
       * "Проекты"
       * "Картотека"
       * "Входящие"

3. Цепочка дат:
   - "Дела" → "Расписание" → "Года" → "Прошлые года" → "2017 год" → "2017 год Сделано" → "Апрель 2017" → "Входящие 13/4/17"

Выводы:
- Данные организованы в древовидную структуру
- Есть корневой элемент и несколько основных ветвей
- Одна из ветвей содержит временную иерархию (года → месяцы → дни)
[2025-04-07 09:27:33] - Решение: Модифицирована обработка эмбеддингов в retrieval.py
- Добавлена поддержка chunked/не chunked режимов
- Внедрены проверки обязательных полей ('embedding', 'text')
- Улучшена обработка ошибок
[2025-04-02 01:12:10] - Решение: Полная синхронизация документации схемы БД с актуальной структурой через MCP запрос. Добавлены недостающие таблицы, индексы и связи.
# Decision Log

This file records architectural and implementation decisions using a list format.
2025-03-30 00:02:32 - Log of updates made.

*

## Decision

* Использование технологии RAG (Retrieval-Augmented Generation) для создания персонального ассистента
* Выбор PostgreSQL в качестве базы данных для хранения элементов и эмбеддингов
* Использование моделей OpenAI для генерации эмбеддингов и ответов
* Реализация кэширования эмбеддингов для повышения производительности
* Создание иерархической структуры данных с родительскими и дочерними элементами
* Разработка интерактивного режима отладки с возможностью настройки параметров

## Rationale 

* RAG позволяет генерировать ответы на основе конкретной базы знаний, что повышает точность и релевантность ответов
* PostgreSQL обеспечивает надежное хранение данных и поддерживает векторные операции для работы с эмбеддингами
* Модели OpenAI предоставляют высококачественные эмбеддинги и генерацию текста
* Кэширование эмбеддингов снижает количество запросов к API и ускоряет работу системы
* Иерархическая структура данных позволяет лучше организовать информацию и учитывать контекст
* Интерактивный режим отладки упрощает разработку и настройку системы

## Implementation Details

* Использование text-embedding-3-large для генерации эмбеддингов с размерностью 3072
* Использование gpt-4-turbo-preview для генерации ответов
* Хранение эмбеддингов в базе данных с использованием типа VECTOR
* Реализация косинусного сходства для поиска релевантных документов
* Использование порогового значения сходства для фильтрации результатов

| 2025-03-30 20:10:09 | Documenting launch parameters | Improve project documentation | Added detailed launch parameters description to productContext.md and systemPatterns.md |
* Автоматическая генерация ключевых слов для запросов с использованием GPT-3.5 Turbo
* Реализация механизма миграции базы данных для обновления схемы

[2025-04-07 00:20:00] - Реализация гибридного поиска (векторный + BM25)
- Детали: Комбинация векторного поиска (text-embedding-3-large) и текстового поиска (BM25) с настраиваемыми весами
- Обоснование: Улучшение точности поиска за счет комбинации семантического и лексического поиска
- Имплементация: retrieval.py, параметры в config.py

[2025-04-07 00:20:00] - Семантическое чанкование документов
- Детали: Разбиение документов по смысловым границам с перекрывающимися чанками
- Обоснование: Улучшение качества контекста для генерации ответов
- Имплементация: embeddings.py, параметры чанков в config.py

[2025-04-07 00:20:00] - Реранжирование результатов с кросс-энкодером
- Детали: Использование bge-reranker-base для улучшения порядка результатов поиска
- Обоснование: Повышение релевантности топовых результатов
- Имплементация: retrieval.py, кэширование результатов

[2025-04-07 00:20:00] - Система оценки качества
- Детали: Внедрение метрик precision@k, recall, NDCG
- Обоснование: Объективная оценка качества поиска и генерации

[2025-04-07 09:05:00] - Рефакторинг обработки форматов данных в retrieval.py
* Добавлена функция get_text() для унифицированного доступа к тексту
* Поддержаны оба формата данных (явное поле 'text' и item['item'][2])
* Сохранена обратная совместимость
* Исправлена ошибка KeyError: 'text' и IndexError
* Все тесты проходят успешно
- Имплементация: evaluation.py, тестовые сценарии в tests/
[2025-04-07 09:10:34] - [Исправление ошибки embeddings]
Добавлена функция count_tokens в embeddings.py для корректного подсчета токенов при семантическом разбиении текста. Функция использует tiktoken.encoding_for_model().

[2025-04-07 23:32:45] - Проблема форматов данных при реранжировании
* Обнаружено: элементы теряются при передаче между search_similar_items и reranker
* Причина: несоответствие форматов данных (list vs dict)
* Предпринято:
  - Добавлено детальное логирование форматов
  - Унифицированы форматы элементов
* Требуется:
  - Ревью архитектуры взаимодействия компонентов
  - Валидация форматов данных на границах